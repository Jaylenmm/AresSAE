name: External Cron Scheduler

on:
  schedule:
    - cron: "0 5 * * *"   # Runs daily at 05:00 UTC (~Midnight US Central during Daylight Time)
  workflow_dispatch: {}

jobs:
  run-crons:
    runs-on: ubuntu-latest
    env:
      BASE_URL: ${{ secrets.PROD_BASE_URL }}
      CRON_SECRET: ${{ secrets.PROD_CRON_SECRET }}
    steps:
      - name: Check required secrets
        run: |
          [ -n "$BASE_URL" ] || { echo "Missing PROD_BASE_URL secret"; exit 1; }
          [ -n "$CRON_SECRET" ] || { echo "Missing PROD_CRON_SECRET secret"; exit 1; }

      - name: Debug secrets presence (no values printed)
        run: |
          echo "Event: $GITHUB_EVENT_NAME; Ref: $GITHUB_REF; Actor: $GITHUB_ACTOR"
          echo "BASE_URL set? $([ -n \"$BASE_URL\" ] && echo yes || echo no)"
          echo "CRON_SECRET set? $([ -n \"$CRON_SECRET\" ] && echo yes || echo no)"
          echo "BASE_URL length: ${#BASE_URL}"
          echo "CRON_SECRET length: ${#CRON_SECRET}"

      - name: Pause 60s before running crons
        run: sleep 60

      # ========================
      # Baseline (0–48, 48–96, 96–144) MLB/NBA
      # ========================
      - name: MLB baseline slices
        run: |
          set -e
          curl -fsS --retry 3 --retry-delay 10 --retry-all-errors --max-time 300 "$BASE_URL/api/cron-mlb?key=$CRON_SECRET&start=0&window=48"
          curl -fsS --retry 3 --retry-delay 10 --retry-all-errors --max-time 300 "$BASE_URL/api/cron-mlb?key=$CRON_SECRET&start=48&window=48"
          curl -fsS --retry 3 --retry-delay 10 --retry-all-errors --max-time 300 "$BASE_URL/api/cron-mlb?key=$CRON_SECRET&start=96&window=48"

      - name: Sleep 20s between groups
        run: sleep 20

      - name: NBA baseline slices
        run: |
          set -e
          curl -fsS --retry 3 --retry-delay 10 --retry-all-errors --max-time 300 "$BASE_URL/api/cron-nba?key=$CRON_SECRET&start=0&window=48"
          curl -fsS --retry 3 --retry-delay 10 --retry-all-errors --max-time 300 "$BASE_URL/api/cron-nba?key=$CRON_SECRET&start=48&window=48"
          curl -fsS --retry 3 --retry-delay 10 --retry-all-errors --max-time 300 "$BASE_URL/api/cron-nba?key=$CRON_SECRET&start=96&window=48"

      - name: Sleep 20s between groups
        run: sleep 20

      - name: NFL/NCAAF baseline (6-day)
        run: |
          set -e
          curl -fsS --retry 3 --retry-delay 10 --retry-all-errors --max-time 600 "$BASE_URL/api/cron-nfl?key=$CRON_SECRET&start=0&window=144"
          curl -fsS --retry 3 --retry-delay 10 --retry-all-errors --max-time 600 "$BASE_URL/api/cron-ncaaf?key=$CRON_SECRET&start=0&window=144"

      # ========================
      # Props (from DB games, no slicing) — run BEFORE alternates
      # ========================
      - name: Sleep 20s before props
        run: sleep 20
      - name: MLB props (DB games) — per book
        run: |
          set -e
          for b in draftkings fanduel betmgm caesars espnbet; do
            curl -fsS --retry 3 --retry-delay 10 --retry-all-errors --max-time 900 "$BASE_URL/api/cron-mlb-props?key=$CRON_SECRET&books=$b"
            sleep 10
          done
      - name: Sleep 20s
        run: sleep 20
      - name: NBA props (DB games) — per book
        run: |
          set -e
          for b in draftkings fanduel betmgm caesars espnbet; do
            curl -fsS --retry 3 --retry-delay 10 --retry-all-errors --max-time 900 "$BASE_URL/api/cron-nba-props?key=$CRON_SECRET&books=$b"
            sleep 10
          done
      - name: Sleep 20s
        run: sleep 20
      - name: NFL props (DB games) — per book
        run: |
          set -e
          for b in draftkings fanduel betmgm caesars espnbet; do
            curl -fsS --retry 3 --retry-delay 10 --retry-all-errors --max-time 900 "$BASE_URL/api/cron-nfl-props?key=$CRON_SECRET&books=$b"
            sleep 10
          done
      - name: Sleep 20s
        run: sleep 20
      - name: NCAAF props (DB games) — per book
        run: |
          set -e
          for b in draftkings fanduel betmgm caesars espnbet; do
            curl -fsS --retry 3 --retry-delay 10 --retry-all-errors --max-time 900 "$BASE_URL/api/cron-ncaaf-props?key=$CRON_SECRET&books=$b"
            sleep 10
          done
      
      # Alternates disabled for now to focus on standard odds and player props
