name: External Cron Scheduler

on:
  schedule:
    - cron: "0 6 * * *"   # Runs daily at 06:00 UTC
  workflow_dispatch: {}

jobs:
  run-crons:
    runs-on: ubuntu-latest
    env:
      BASE_URL: ${{ secrets.PROD_BASE_URL }}
      CRON_SECRET: ${{ secrets.PROD_CRON_SECRET }}
    steps:
      - name: Check required secrets
        run: |
          [ -n "$BASE_URL" ] || { echo "Missing PROD_BASE_URL secret"; exit 1; }
          [ -n "$CRON_SECRET" ] || { echo "Missing PROD_CRON_SECRET secret"; exit 1; }

      # ========================
      # Baseline (0–48, 48–96, 96–144) MLB/NBA
      # ========================
      - name: MLB baseline slices
        run: |
          set -e
          curl -fsS --retry 3 --retry-delay 10 --retry-all-errors --max-time 300 "$BASE_URL/api/cron-mlb?key=$CRON_SECRET&start=0&window=48"
          curl -fsS --retry 3 --retry-delay 10 --retry-all-errors --max-time 300 "$BASE_URL/api/cron-mlb?key=$CRON_SECRET&start=48&window=48"
          curl -fsS --retry 3 --retry-delay 10 --retry-all-errors --max-time 300 "$BASE_URL/api/cron-mlb?key=$CRON_SECRET&start=96&window=48"

      - name: Sleep 60s between groups
        run: sleep 60

      - name: NBA baseline slices
        run: |
          set -e
          curl -fsS --retry 3 --retry-delay 10 --retry-all-errors --max-time 300 "$BASE_URL/api/cron-nba?key=$CRON_SECRET&start=0&window=48"
          curl -fsS --retry 3 --retry-delay 10 --retry-all-errors --max-time 300 "$BASE_URL/api/cron-nba?key=$CRON_SECRET&start=48&window=48"
          curl -fsS --retry 3 --retry-delay 10 --retry-all-errors --max-time 300 "$BASE_URL/api/cron-nba?key=$CRON_SECRET&start=96&window=48"

      - name: Sleep 60s between groups
        run: sleep 60

      - name: NFL/NCAAF baseline (6-day)
        run: |
          set -e
          curl -fsS --retry 3 --retry-delay 10 --retry-all-errors --max-time 600 "$BASE_URL/api/cron-nfl?key=$CRON_SECRET&start=0&window=144"
          curl -fsS --retry 3 --retry-delay 10 --retry-all-errors --max-time 600 "$BASE_URL/api/cron-ncaaf?key=$CRON_SECRET&start=0&window=144"

      # ========================
      # Props (from DB games, no slicing) — run BEFORE alternates
      # ========================
      - name: Sleep 60s before props
        run: sleep 60
      - name: MLB props (DB games)
        run: |
          set -e
          curl -fsS --retry 3 --retry-delay 10 --retry-all-errors --max-time 900 "$BASE_URL/api/cron-mlb-props?key=$CRON_SECRET"
      - name: Sleep 20s
        run: sleep 20
      - name: NBA props (DB games)
        run: |
          set -e
          curl -fsS --retry 3 --retry-delay 10 --retry-all-errors --max-time 900 "$BASE_URL/api/cron-nba-props?key=$CRON_SECRET"
      - name: Sleep 20s
        run: sleep 20
      - name: NFL props (DB games)
        run: |
          set -e
          curl -fsS --retry 3 --retry-delay 10 --retry-all-errors --max-time 900 "$BASE_URL/api/cron-nfl-props?key=$CRON_SECRET"
      - name: Sleep 20s
        run: sleep 20
      - name: NCAAF props (DB games)
        run: |
          set -e
          curl -fsS --retry 3 --retry-delay 10 --retry-all-errors --max-time 900 "$BASE_URL/api/cron-ncaaf-props?key=$CRON_SECRET"

      # ========================
      # Alternates near-term (0–48) — run AFTER props
      # ========================
      - name: Sleep 60s before alternates
        run: sleep 60
      - name: MLB alternates 0–48h
        run: |
          set -e
          curl -fsS --retry 3 --retry-delay 10 --retry-all-errors --max-time 900 "$BASE_URL/api/cron-mlb-alts?key=$CRON_SECRET&start=0&window=48"
      - name: Sleep 20s
        run: sleep 20
      - name: NBA alternates 0–48h
        run: |
          set -e
          curl -fsS --retry 3 --retry-delay 10 --retry-all-errors --max-time 900 "$BASE_URL/api/cron-nba-alts?key=$CRON_SECRET&start=0&window=48"
      - name: Sleep 20s
        run: sleep 20
      - name: NFL alternates 0–48h
        run: |
          set -e
          curl -fsS --retry 3 --retry-delay 10 --retry-all-errors --max-time 900 "$BASE_URL/api/cron-nfl-alts?key=$CRON_SECRET&start=0&window=48"
      - name: Sleep 20s
        run: sleep 20
      - name: NCAAF alternates 0–48h
        run: |
          set -e
          curl -fsS --retry 3 --retry-delay 10 --retry-all-errors --max-time 900 "$BASE_URL/api/cron-ncaaf-alts?key=$CRON_SECRET&start=0&window=48"
